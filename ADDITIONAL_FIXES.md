# Дополнительные исправления приложения доставки

## Исправленные проблемы:

### 1. ✅ Проблема с сохранением координат в AddressSelectScreen
**Проблема**: При выборе координат второй точки, выбранные координаты первой пропадали
**Причина**: navigation.setParams очищал все параметры, включая уже выбранные координаты
**Решение**: 
- Убрана очистка параметров navigation.setParams
- Упрощена логика обработки координат в useEffect
- Координаты теперь обрабатываются независимо друг от друга

### 2. ✅ Проблема с некликабельным полем сборщика
**Проблема**: При редактировании доставки поле ФИО сборщика было некликабельным
**Причина**: Условная логика отображала разные варианты List.Item для существующих и новых доставок
**Решение**:
- Объединена логика отображения в один List.Item
- Поле сборщика теперь всегда кликабельно
- Добавлена индикация ошибки валидации для поля сборщика

### 3. ✅ Проблема с потерей авторизации (ошибка 401)
**Проблема**: Спустя время приложение зависало из-за истечения токена авторизации
**Причина**: 
- Неправильная обработка ошибок refresh токена в axios интерсепторе
- Отсутствие автоматической проверки валидности токенов
**Решение**:
- Улучшен axios интерсептор с правильной обработкой refresh токенов
- Добавлен флаг `_retry` для предотвращения бесконечных циклов
- Добавлена автоматическая очистка токенов при истечении refresh токена
- Добавлена функция `checkTokenValidity` в AuthContext
- Добавлена периодическая проверка токенов в DeliveriesScreen

### 4. ✅ Проблема с полем created_by при создании доставки
**Проблема**: При создании доставки возникала ошибка "This field is required" для поля created_by
**Причина**: В payload не передавался ID сборщика (created_by)
**Решение**:
- Добавлена проверка обязательности поля collector для новых доставок
- Добавлена передача safeCollectorId в payload как created_by
- Добавлена индикация ошибки валидации в UI

## Технические детали исправлений:

### AuthContext:
```typescript
// Добавлена функция проверки валидности токена
checkTokenValidity: () => Promise<void>;

// Автоматическое обновление токена через refresh
const checkTokenValidity = async () => {
  // Проверка через защищенный эндпоинт
  // Автоматическое обновление при 401
  // Логаут при истечении refresh токена
}
```

### Axios интерсептор:
```typescript
// Улучшенная обработка 401 ошибок
if (error.response?.status === 401 && !originalRequest._retry) {
  originalRequest._retry = true;
  // Попытка обновления токена
  // Автоматическая очистка при неудаче
}
```

### DeliveryFormScreen:
```typescript
// Добавлена валидация сборщика для новых доставок
if (!currentDelivery && !collector) newErrors.collector = true;

// Добавлена передача created_by в payload
...(safeCollectorId !== undefined && { created_by: safeCollectorId })
```

### AddressSelectScreen:
```typescript
// Упрощенная обработка координат без очистки параметров
useEffect(() => {
  if (route.params?.selectedCoord && route.params?.coordLabel) {
    // Обработка без navigation.setParams
  }
}, [route.params?.selectedCoord, route.params?.coordLabel]);
```

## Результат:
- ✅ Координаты сохраняются корректно при выборе двух точек
- ✅ Поле сборщика всегда кликабельно и функционально
- ✅ Автоматическое обновление токенов предотвращает зависания
- ✅ Создание доставки работает с корректной передачей сборщика
- ✅ Улучшена обработка ошибок авторизации
- ✅ Добавлены визуальные индикаторы ошибок валидации

Все проблемы решены и приложение работает стабильно!
